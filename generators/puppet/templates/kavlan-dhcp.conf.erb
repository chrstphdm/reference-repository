# MANAGED BY PUPPET
# Module : kavlang5k
# GENERATED by kavlang5k.rb

ddns-update-style none;
option space pxelinux;
option pxelinux.magic      code 208 = string;
option pxelinux.configfile code 209 = text;
option pxelinux.pathprefix code 210 = text;
option pxelinux.reboottime code 211 = unsigned integer 32;
option vendorinfo          code 43  = string;

<%
require 'ip'
kavlan = refapi['sites'][site_uid]['kavlans'][kavlan_id]
kavlan_ip = IP.new(kavlan['network'])
-%>

subnet <%= kavlan_ip.network.to_addr %> netmask <%= kavlan_ip.netmask.to_addr %> {
    default-lease-time 86400;
    max-lease-time 604800;
    option domain-name-servers <%= kavlan_id.to_i.between?(1, 3)? kavlan['gateway'] : "dns.#{site_uid}.grid5000.fr" %>;
    option ntp-servers <%= kavlan_id.to_i.between?(1, 3)? kavlan['gateway'] : "ntp.#{site_uid}.grid5000.fr" %>;
    option routers <%= kavlan['gateway'] %>;
    option subnet-mask <%= kavlan_ip.netmask.to_addr %>;
    option broadcast-address <%= kavlan_ip.broadcast.to_addr %>;
    filename  "pxelinux.0";
    next-server <%= kavlan_id.to_i.between?(1, 3)? kavlan['gateway'] : "kadeploy.#{site_uid}.grid5000.fr" %>;

<%
refapi['sites'].sort.to_h.each_key do |site|
  next if kavlan_id.to_i.between?(1, 9) and site != site_uid
  refapi['sites'][site].fetch('clusters', []).sort.to_h.each do |cluster_uid, cluster|
    cluster['nodes'].sort.to_h.each do |node_uid, node|
      next if node['status'] and node['status'] == 'retired'
      node['network_adapters'].each do |interface_uid, interface|
        if (interface['mountable'] or site == "rennes") and node['kavlan'] and node['kavlan'].has_key?(interface_uid) # TODO: use interface['kavlan']
          if not interface['mac'] or not node['kavlan'].has_key?(interface_uid) or not node['kavlan'][interface_uid]["kavlan-#{kavlan_id}"]
            warn "WARN: Cannot fill dhcpd entry for #{node_uid}, interface #{interface_uid} in vlan #{kavlan_id}: " \
              "Missing mac (#{interface['mac']}) or IP (#{node['kavlan'][interface_uid] and node['kavlan'][interface_uid]["kavlan-#{kavlan_id}"]})"
            next
          end
-%>
   host <%= node_uid %><%= interface['mounted']? "" : "-"+interface_uid %>-kavlan-<%= kavlan_id %>.<%= site %>.grid5000.fr {
     hardware ethernet <%= interface['mac'].downcase() %>;
     option host-name "<%= node_uid %><%= interface['mounted']? "" : "-"+interface_uid %>-kavlan-<%= kavlan_id %>";
     option domain-name "<%= site %>.grid5000.fr";
     fixed-address <%= node['kavlan'][interface_uid]["kavlan-#{kavlan_id}"] %>;
<%        if kavlan_id > 9 -%>
     next-server kadeploy.<%= site %>.grid5000.fr;
<%        end -%>
   }
<%
        end
      end
    end
  end
end
-%>
}

#
# This file was generated from reference-repository.git
# Do not edit this file by hand. Your changes will be overwritten.
#

<%-
netdev.fetch('metrics', []).each {|metric|
  next if metric['source']['protocol'] != 'snmp'
  if metric['source']['id'].include?('%SNMP_IFACE%')
    netdev['linecards'].each_with_index {|linecard, linecard_uid|
      linecard.fetch('ports', []).each_with_index {|lport, lport_uid|
        next if lport.empty?
        lport_uid += 12
        port_uid = netdev['linecards'].length > 1 ? "#{linecard_uid}_#{lport_uid}" : lport_uid
        port_name = linecard["snmp_pattern"].sub("%LINECARD%",linecard_uid.to_s).sub("%PORT%",lport_uid.to_s)
        # TODO: Handle secondary interface
        port_node = lport['uid']
-%>
- name: <%= metric['name'] %>
  device_id: <%= netdev_uid %>-port-<%= port_uid %>
  device_alias: <%= port_node %>
  url: snmp://<%= netdev.fetch('snmp_community', 'public')%>@<%= netdev_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'].sub('%SNMP_IFACE%',  "{{ #{port_name} }}") %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>

<%-
      }
    }
  else
-%>
- name: <%= metric['name'] %>
  device_id: <%= netdev_uid %>
  url: snmp://<%= netdev.fetch('snmp_community', 'public')%>@<%= netdev_uid %>.<%= site_uid %>.grid5000.fr/<%= metric['source']['id'] %>
  update_every: <%= metric['period'] > 0 ? metric['period'] : metric['optional_period'] %>
<%- if metric['period'] == 0 -%>
  optional: true
<%- end -%>

<%-
  end
}
-%>

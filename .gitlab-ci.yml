stages:
- validate
- generate
- deploy

validate-data:
   stage: validate
   tags:
    - grid5000-docker
   image: debian:stretch
   script:
    - apt-get update && apt-get -y install ruby rake ruby-hashdiff
    - gem install hash_validator
    - cd generators/input-validators/
    - ruby yaml-input-schema-validator.rb
    - ruby yaml-input-find-duplicates.rb

generate-reference-api:
   stage: generate
   tags:
    - grid5000-docker
   image: debian:stretch
   script:
    - apt-get update && apt-get -y install ruby rake ruby-hashdiff git
    - gem install hash_validator
    - export TZ=Europe/Paris
    - rake reference-api
    - git status
    - echo "Checking that git status output is empty..."
    - [ "`git status -s`" = "" ]
    - git diff --exit-code

deploy:
   stage: deploy
   tags:
    - grid5000-shell
   script:
    - /srv/ci-runner-scripts/bin/update-api-servers
